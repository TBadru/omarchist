#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'HELP'
Usage:
  ./update-version major
  ./update-version minor
  ./update-version patch
  ./update-version 1.0.2
  ./update-version --version 1.0.2

Note:
  Run this from the project root.

Updates:
  - package.json
  - src-tauri/Cargo.toml
  - src-tauri/tauri.conf.json
  - src/routes/about/+page.svelte
HELP
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || -z "${1:-}" ]]; then
  usage
  exit 0
fi

script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
cwd="$(pwd -P)"

# Define file paths
package_json="${cwd}/package.json"
cargo_toml="${cwd}/src-tauri/Cargo.toml"
tauri_conf="${cwd}/src-tauri/tauri.conf.json"
about_page="${cwd}/src/routes/about/+page.svelte"

# Validation
if [[ ! -f "${package_json}" || ! -f "${cargo_toml}" ]]; then
  echo "Error: run this from the project root."
  exit 1
fi

# Extract current version from package.json
current_version=$(grep -m1 '"version": "[0-9]\+\.[0-9]\+\.[0-9]\+"' "${package_json}" | sed -E 's/.*"version": "([0-9]+\.[0-9]+\.[0-9]+)".*/\1/')

if [[ -z "${current_version}" ]]; then
    echo "Error: Could not extract current version from package.json"
    exit 1
fi

version=""
input="${1:-}"

if [[ "$input" == "major" ]]; then
    echo "Current version: ${current_version}"
    IFS='.' read -r major minor patch <<< "$current_version"
    version="$((major + 1)).0.0"
elif [[ "$input" == "minor" ]]; then
    echo "Current version: ${current_version}"
    IFS='.' read -r major minor patch <<< "$current_version"
    version="${major}.$((minor + 1)).0"
elif [[ "$input" == "patch" ]]; then
    echo "Current version: ${current_version}"
    IFS='.' read -r major minor patch <<< "$current_version"
    version="${major}.${minor}.$((patch + 1))"
else
    case "${input}" in
      --version)
        version="${2:-}"
        ;;
      --*)
        version="${input#--}"
        ;;
      *)
        version="${input}"
        ;;
    esac
fi

if [[ -z "${version}" ]]; then
  echo "Error: missing version."
  usage
  exit 1
fi

if ! [[ "${version}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
  echo "Error: invalid version '${version}'. Expected format: X.Y.Z"
  exit 1
fi

echo "Updating version to ${version}"

# 1. Update package.json
# "version": "0.8.1",
echo "  Updating package.json..."
NEW_VERSION="${version}" perl -i -pe '
  my $v = $ENV{NEW_VERSION};
  s/("version": ")\d+\.\d+\.\d+(")/$1$v$2/;
' "${package_json}"

# 2. Update src-tauri/Cargo.toml
# version = "0.8.1"
echo "  Updating src-tauri/Cargo.toml..."
NEW_VERSION="${version}" perl -0777 -i -pe '
  my $v = $ENV{NEW_VERSION};
  s/(\[package\][^\[]*?\bversion\s*=\s*")[^"]*(")/$1$v$2/s
  or die "Failed to update [package].version in src-tauri/Cargo.toml\n";
' "${cargo_toml}"

# 3. Update src-tauri/tauri.conf.json
# "version": "0.8.1",
echo "  Updating src-tauri/tauri.conf.json..."
NEW_VERSION="${version}" perl -i -pe '
  my $v = $ENV{NEW_VERSION};
  # Only replace the top-level version key, typically found early in file
  # Note: A simple regex might replace other keys named version if they exist.
  # But tauri.conf.json usually has "version": "..." at top level.
  s/("version": ")\d+\.\d+\.\d+(")/$1$v$2/;
' "${tauri_conf}"

# 4. Update src/routes/about/+page.svelte
# <span class="text-muted-foreground">v0.8.1</span>
echo "  Updating src/routes/about/+page.svelte..."
NEW_VERSION="${version}" perl -i -pe '
  my $v = $ENV{NEW_VERSION};
  s/(<span class="text-muted-foreground">v)\d+\.\d+\.\d+(<\/span>)/$1$v$2/;
' "${about_page}"

echo "Done."
